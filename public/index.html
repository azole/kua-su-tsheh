<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Test</title>
    <style>
      .current-line {
        background-color: #00d1b2;
        color: #fff;
      }
      table {
        border-collapse: collapse;
      }
      tr.kha {
        border-bottom: 1px solid #ddd;
      }
      tr.rom {
      }
      td.rom {
        font-size: 12px;
      }
    </style>
  </head>
  <body>
    <button id="btnStart">選擇播放</button>
    <audio id="player" controls="controls" style="display: none">Your browser does not support the audio element.</audio>
    <table id="subtitle"></table>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/0.26.1/axios.min.js"></script>
    <script>
      $(function () {
        let audioEle = document.getElementById('player');
        let timer = null;
        let $subtitle = $('#subtitle');
        let $allRomTrs = null;
        let $allKhaTrs = null;
        let totalLines = 0;
        function processSubtitle() {
          let currentTime = audioEle.currentTime * 10;
          let currentLineIdx = null;
          let currentLines = $allRomTrs.filter(function (idx, tr) {
            let isCurrent = $(this).data('start') <= currentTime && $(this).data('end') > currentTime;
            if (isCurrent) {
              currentLineIdx = $(this).data('idx');
            }
            return isCurrent;
          });
          if (currentLines.length) {
            let showStart = 0,
              showEnd = 0;
            if (currentLineIdx <= 2) {
              showStart = 0;
              showEnd = 5;
            } else if (currentLineIdx >= totalLines - 3) {
              showStart = totalLines - 5;
              showEnd = totalLines;
            } else {
              showStart = currentLineIdx - 2;
              showEnd = currentLineIdx + 3;
            }
            $allRomTrs.hide();
            $allKhaTrs.hide();
            for (let i = showStart; i <= showEnd; i++) {
              $allRomTrs.eq(i).show();
              $allKhaTrs.eq(i).show();
            }
            $allRomTrs.removeClass('current-line');
            $allKhaTrs.removeClass('current-line');
            currentLines.addClass('current-line');
            currentLines.next().addClass('current-line');
          }
          // console.log('currentTime', currentTime);
          // console.log('audioEle.played', audioEle.played, audioEle.paused);
          if (!audioEle.paused) {
            timer = setTimeout(processSubtitle, 100);
          }
        }
        $('#btnStart').on('click', async () => {
          $('#btnStart').hide();
          let res = await axios.get('/api/read-file');
          totalLines = res.data.subtitle.length;
          res.data.subtitle.map((line, idx) => {
            let $trRom = $('<tr>').data('idx', idx).data('type', 'rom').data('start', line.start).data('end', line.end).addClass('rom');
            line.rom.map((r, idx) => {
              let time = line.jump.length === 1 ? line.jump[0] : line.jump[idx];
              $trRom.append($('<td>').text(r).data('time', time).addClass('rom'));
            });
            $subtitle.append($trRom);

            let $trKha = $('<tr>').data('idx', idx).data('type', 'kha').data('start', line.start).data('end', line.end).addClass('kha');
            line.kha.map((k, idx) => {
              let time = line.jump.length === 1 ? line.jump[0] : line.jump[idx];
              $trKha.append($('<td>').data('time', time).text(k));
            });
            $subtitle.append($trKha);
          });
          $allRomTrs = $subtitle.find('tr.rom');
          $allKhaTrs = $subtitle.find('tr.kha');
          $('#player').attr('src', res.data.audio);
          $('#player').show();
          audioEle.play();
          timer = setTimeout(processSubtitle, 100);
        });
        audioEle.onplay = function () {
          // console.log('audioEle.onplay');
          timer = setTimeout(processSubtitle, 100);
        };
        audioEle.onpause = function () {
          // console.log('audioEle.onpause');
          clearInterval(timer);
        };
      });
    </script>
  </body>
</html>
